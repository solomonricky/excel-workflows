name: Timeslot Tracker

on:
  issues:
    types: [opened]

jobs:
  track-changes:
    if: contains(github.event.issue.title, 'Timeslot modified')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  # To fetch all history for comparing changes

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openpyxl requests
    
    - name: Check if today is a weekday
      id: weekday-check
      run: |
        DAY_OF_WEEK=$(date +%u)
        if [ "$DAY_OF_WEEK" -ge 1 ] && [ "$DAY_OF_WEEK" -le 5 ]; then
          echo "is_weekday=true" >> $GITHUB_ENV
        else
          echo "is_weekday=false" >> $GITHUB_ENV
        fi

    - name: Download latest Excel file
      if: env.is_weekday == 'true'
      run: |
        wget -O timeslot.xlsx "https://cloudmails-my.sharepoint.com/:x:/g/personal/paul_nueva_cloudmails_onmicrosoft_com/EbBiWw-PrchKmxz-FOtskXkBRYs5safy48Rgq1EMFEkWUg?download=1"
    
    - name: Compare Excel Files
      if: env.is_weekday == 'true'
      id: compare
      run: |
        python compare_excel.py timeslot.xlsx data/Timeslot.xlsx

    - name: Move and commit new Timeslot.xlsx
      if: env.is_weekday == 'true' && steps.compare.outputs.changes_detected == 'true'
      run: |
        mv timeslot.xlsx data/Timeslot.xlsx
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add data/Timeslot.xlsx
        git commit -m "Update Timeslot.xlsx with latest changes"
        git push origin HEAD:main
